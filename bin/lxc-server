#!/usr/bin/env ruby

lib = File.expand_path(File.dirname(__FILE__) + '/../lib')
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

require 'rubygems'
require 'eventmachine'
require 'thin'
require 'lxc'
require 'lxc/server'

def terminate(message, exit_code=1)
  STDERR.puts(message)
  exit(exit_code)
end

# Check if system have LXC installed
if LXC.binary_installed?('lxc-version')
  if LXC.version < '0.7.5'
    terminate("LXC >= v0.7.5 required.")
  end
else
  terminate("LXC is not installed.")
end

# First, check if lxc tools are installed
if !LXC.installed?
  terminate("Some of the LXC tools are missing.")
end

EM.run do
  Thin::Server.start(LXC::Server, '0.0.0.0', 27000)
end